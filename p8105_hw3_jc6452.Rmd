---
title: "Homework 3"
author: "Jeong Yun Choi"
date: Oct.16.2024
output: github_document
---

```{r, message = FALSE, echo = FALSE}
library(tidyverse)
library(p8105.datasets)
library(ggridges)
library(patchwork)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

## importing data and cleaning up
```{r}
data("ny_noaa")

ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

hex + ridge
```

# Problem 2

## importing data and cleaning up
```{r}
participant = read_csv("data/participant.csv", skip = 4) %>% 
  janitor::clean_names() %>% 
  mutate(
    sex = case_match(
      sex,
      1 ~ "male",
      2 ~ "female"),
    education = case_match(
      education,
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"
    ),
    education = as.factor(education)
  )

accelerometer = read_csv("data/accelerometer.csv",) %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    cols = min1:min1440,
    names_to = "time_elasped",
    names_transform = list(time_elasped = as.integer),
    values_to = "mims",
    names_prefix = "min"
  )

study = left_join(participant, accelerometer, by = "seqn") %>% 
  filter(age >= 21) %>% 
  drop_na(education)
```


```{r sex }
participant %>%
  drop_na(education) %>% 
  count(sex, education)

#Female Age Distribution
participant %>% drop_na(education) %>% 
  ggplot(aes(x= age, fill = sex)) +
  facet_grid(.~education) +
  geom_histogram(bins = 6, position = "dodge")+ 
  labs(title = "Age distributions for male and female in each education category")
```
Based on the plot above, females in the 40 to have the greatest number of people that had more than high school level education. Generally, males demonstrate to have had greatest number of more than high school level education up until 60. After 60 age group, the general education level tends to decrease with greater number of both female and male population who had less than high school level education. Overall, the younger generation definitely seemed to be more invested in the level of education with trend of higher education decreasing as the age increases. 

```{r}
total_activity = study %>% 
  group_by(seqn, sex, age, education) %>% 
  summarize(
    total_activity = sum(mims))

total_activity %>% 
ggplot(aes(x = age, y = total_activity, color = sex))+
  facet_grid(.~education) +
  geom_smooth(se = FALSE)+
  geom_point()+ 
  labs(title = "Total Activities vs Age",
       x = "Age",
       y = "Total Activities",
       color = "Education") +
  viridis::scale_color_viridis(discrete = TRUE) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
```
Based on the plot above, I can observe that there is an overall decreasing activity for all education level as age increases. Also, the group with less than high school level education has the greatest total activities to begin with for both sex around age 20. For groups with more than high school level and high school equivalent level of education, the total activity for female seems to be generally higher throughout the age. Interestingly, the total activities demonstrates to be rather constant throughout the age for group with more than high school level education. 

```{r}
study %>% 
  ggplot(aes(x = time_elasped/60, y= mims, color = sex)) +
  geom_point(alpha = 0.15) +
  geom_smooth(aes(group = sex),se = FALSE) +
  facet_grid(.~education) +
  labs(title = 'More than high school level education',
       x = 'Time (hour) ', 
       y = 'Activity',
       color = 'Sex') +
  theme(legend.position = "bottom")
```
The trend as seen via the smooth line demonstrates to be similar cross all three panels: There is an increase in the activity after 5 hours have elapsed and peaks around 10-12 hour. The activity slowly decreases after hour 20. While the "High school equivalent" and "Less than high school" education groups show similar patterns individually, the "more than high school" group shows some variability. Especially noting the predominantly female peak activity between hour 5-7 and predominantly male peak activity from hour 20-22 (8-10pm). 

## Problem 3
```{r, message = FALSE}
Jan2020 = read_csv("data/citibike/Jan 2020 Citi.csv.zip") %>% 
  janitor::clean_names() %>% 
  mutate(
    date = "Jan 2020"
  )

Jan2024 = read_csv("data/citibike/Jan 2024 Citi.csv.zip") %>% 
  janitor::clean_names() %>% 
  mutate(
    date = "Jan 2024"
  )

July2020 = read_csv("data/citibike/July 2020 Citi.csv.zip") %>% 
  janitor::clean_names() %>% 
  mutate(
    date = "July 2020"
  )

July2024 = read_csv("data/citibike/July 2024 Citi.csv.zip") %>% 
  janitor::clean_names() %>% 
  mutate(
    date = "July 2024"
  )
```


```{r}
citi = bind_rows(
  Jan2020, Jan2024, July2020, July2024
)
```


```{r}
citi %>% 
  count(date, member_casual) %>% 
  knitr::kable()
```
Based on the table above, we can see that Citi Bike members are taking the ride more frequently overall. However, there has been a drastic increase in both casual and member riders in July 2024 compared to other dates, almost double the number from July 2020.

### 5 most popular starting stations for July 2024
```{r}
citi %>% 
  filter(date == "July 2024") %>% 
  count(start_station_name) %>% 
  arrange(desc(n)) %>% 
  head(5) %>% 
  knitr::kable()
```

### separating month and year
```{r}
citi = citi %>% 
  separate(date, c('month', 'year'), sep = " ", remove = TRUE)
```

### aggregating by the different weekdays, month and year
```{r}
citi_effect = citi %>% 
  group_by(weekdays, month, year) %>% 
  summarise(
    median_duration = median(duration, na.rm = TRUE)
  ) %>% 
  mutate(
    weekdays = factor(weekdays,
    levels = c("Monday", "Tuesday","Wednesday", "Thursday", "Friday", "Saturday", "Sunday"),
    ordered = TRUE))
  
```

### plotting to see the trend for median duration based on weekdays, month and year
```{r}
citi_effect %>% 
  ggplot(aes(x = weekdays, y = median_duration, group = year, color = month)) +
  geom_line() +
  facet_grid(year~month) + 
  labs(
    title = "Median Ride Duration by weekdays, month and year",
    x = "Weekdays",
    y = "Median Duration",
    color = "Month",
    group = "Year") +
  theme(legend.position = "bottom") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```
Based on the plot genearted above, there is an increase in median duration in riding the Citi Bike in July. Generally, July is in the middle of summer, so it's warmer to ride bikes than in January (winter). Looking at the weekday trends, generally there is an upward spike in the median duration for the weekends, starting from Friday. There seems to be a tendency in 2024, for people to take short bike rides on Sunday compared to other days in the weekend, and general decrease in the median duration compared to 2020. 

```{r}
citi %>% 
  filter(year == "2024") %>% 
  ggplot(aes(x = rideable_type, y = duration))+
  geom_violin() + 
  facet_grid(month ~ member_casual) + 
  labs (
    title = "Ride Duration vs. Bike type Depending on Membership Status and Month",
    x = "Type of Bike",
    y = "Ride Duration") +
  theme_minimal()
```
The violin plot generated above shows the comparison of distribution among the types of bike, classic and electric, across different month for both casual and Citibike member riders. We can observe that overall there is a tendency for casual riders to ride for longer duration in July, likely due to warmer weather based on the wider density. There seems to be minimal difference between the violin plot for Citibike members throughout the months, except for shorter ride duration for electric bike in January. One reason could be that Citibike members utilize the bike for commuting and this will likely not change throughout the season. Another observation is that the electric bike tends to have shorter ride duration that classic bike. This could be due to the fact that electric bike will take less amount of time to arrive at the destination than classic bike, hence resulting in a shorter ride duration. Overall, the seasonal trend demonstrates a longer ride duration for July compared to January.
